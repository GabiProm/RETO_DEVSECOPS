name: CI/CD DevSecOps

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
    - name: Clonar el repositorio
      uses: actions/checkout@v3

    - name: Configurar Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    - name: Instalar dependencias
      run: npm install

    - name: Ejecutar aplicación en segundo plano
      run: nohup npm start &

    - name: Esperar que el servidor levante
      run: sleep 5

    - name: Validar respuesta del endpoint
      run: |
        RESPONSE=$(curl -s http://localhost:3000/api/status)
        echo "Respuesta del servidor: $RESPONSE"
        echo "$RESPONSE" | grep "error" && exit 1 || echo "✅ Sin errores detectados"

    - name: Simular despliegue
      run: echo "Despliegue simulado ✅"